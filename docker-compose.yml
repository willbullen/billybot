# BillyBot Docker Compose
# Runs ByYourCommand (ROS 2), Nanobot, and Dashboard in containers.
#
# Usage:
#   cp .env.example .env   # Fill in your API keys
#   docker compose up -d
#
# For Jetson (GPU):
#   docker compose --profile jetson up -d

services:
  # ---------------------------------------------------------------------------
  # ROS 2 - ByYourCommand
  # Voice interaction, VAD, AI agents, audio pipeline, bridge
  # ---------------------------------------------------------------------------
  ros2-byc:
    build:
      context: ./ros
      dockerfile: Dockerfile
    container_name: billybot-ros2
    network_mode: host          # Simplifies DDS discovery and audio
    privileged: false
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - PULSE_SERVER=unix:/run/pulse/native
    volumes:
      # ROS 2 source (live editing with symlink-install)
      - ./ros:/ros2_ws/src/by_your_command:rw
      # PulseAudio socket for audio I/O
      - /run/user/1000/pulse:/run/pulse:ro
      - ~/.config/pulse/cookie:/root/.config/pulse/cookie:ro
      # Shared memory for CycloneDDS zero-copy transport
      - /dev/shm:/dev/shm
      # Tmp for voice recordings
      - /tmp/prompt_voice:/tmp/prompt_voice
    devices:
      # Audio devices (ALSA)
      - /dev/snd:/dev/snd
      # UART to DDSM Driver HAT (adjust device path for your Jetson)
      # Uncomment and set the correct device:
      # - /dev/ttyTHS1:/dev/ttyTHS1
      # - /dev/ttyUSB0:/dev/ttyUSB0
      # USB cameras (RealSense / ZED)
      # - /dev/bus/usb:/dev/bus/usb
      # - /dev/video0:/dev/video0
      # - /dev/video1:/dev/video1
    # GPU access for Jetson (NVIDIA Container Runtime)
    # Uncomment for Jetson deployment:
    # runtime: nvidia
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    cap_add:
      - SYS_NICE             # Real-time audio scheduling
    restart: unless-stopped
    command: >
      ros2 launch by_your_command oai_realtime.launch.py
        openai_api_key:=${OPENAI_API_KEY:-}

  # ---------------------------------------------------------------------------
  # Nanobot - AI Assistant Framework
  # Multi-channel bot (Telegram, Slack, WhatsApp, etc.) for remote management
  # ---------------------------------------------------------------------------
  nanobot:
    build:
      context: ./nanobot
      dockerfile: Dockerfile
    container_name: billybot-nanobot
    ports:
      - "${NANOBOT_PORT:-18790}:18790"
    environment:
      # pydantic_settings: NANOBOT_ prefix + __ nested delimiter
      - NANOBOT_PROVIDERS__OPENAI__API_KEY=${NANOBOT_LLM_API_KEY:-}
      - NANOBOT_AGENTS__DEFAULTS__MODEL=${NANOBOT_LLM_MODEL:-gpt-4o}
      - NANOBOT_CHANNELS__TELEGRAM__TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - NANOBOT_CHANNELS__TELEGRAM__ENABLED=${TELEGRAM_BOT_TOKEN:+true}
      - NANOBOT_CHANNELS__SLACK__BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - NANOBOT_CHANNELS__DISCORD__TOKEN=${DISCORD_BOT_TOKEN:-}
      - ROS2_CONTAINER_NAME=billybot-ros2
    volumes:
      - nanobot-config:/root/.nanobot
      - nanobot-workspace:/app/workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro   # Docker API for ROS 2 tool
      - ./ros:/app/ros2_workspace:rw                    # Direct file access to ROS source
    restart: unless-stopped
    command: gateway --port 18790

  # ---------------------------------------------------------------------------
  # Dashboard - Web UI for robot monitoring and control
  # Modern dark-theme dashboard with touch joysticks, telemetry, and management
  # ---------------------------------------------------------------------------
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: billybot-dashboard
    ports:
      - "${DASHBOARD_PORT:-8000}:8000"
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-insecure-change-me}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-true}
      - ROS2_BRIDGE_WS=ws://localhost:8765
      - ROS2_CONTAINER_NAME=billybot-ros2
      - NANOBOT_CONTAINER_NAME=billybot-nanobot
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./dashboard:/app:rw
    depends_on:
      - redis
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Redis - Channel layer for Django Channels WebSocket support
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: billybot-redis
    restart: unless-stopped

volumes:
  nanobot-config:
  nanobot-workspace:
