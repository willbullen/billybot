{% extends "core/base.html" %}
{% block title %}Behaviors{% endblock %}
{% block page_title %}Autonomous Behaviors{% endblock %}

{% block extra_head %}
<style>
  .hud-panel { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(6, 182, 212, 0.2); }
  .hud-panel:hover { border-color: rgba(6, 182, 212, 0.35); }
  .behavior-card { transition: all 0.3s; cursor: pointer; }
  .behavior-card:hover { transform: translateY(-2px); }
  .behavior-card.active { border-color: rgba(6, 182, 212, 0.6); box-shadow: 0 0 20px rgba(6, 182, 212, 0.15); }
  @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .spin-slow { animation: spin-slow 3s linear infinite; }
</style>
{% endblock %}

{% block content %}
<div x-data="behaviorsApp()" x-init="init()">

  <!-- Status bar -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div class="flex items-center gap-4 flex-wrap">
      <div class="flex items-center gap-2 text-sm">
        <span class="w-2.5 h-2.5 rounded-full" :class="connected ? 'bg-emerald-500 pulse-dot' : 'bg-slate-600'"></span>
        <span class="text-slate-400" x-text="connected ? 'Behavior Manager connected' : 'Disconnected'"></span>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="font-mono text-cyan-300" x-text="'STATE: ' + currentState.toUpperCase()"></span>
      </div>
      <div x-show="currentState !== 'idle'" class="flex items-center gap-2 text-sm">
        <span class="text-slate-500 font-mono" x-text="timeInState + 's'"></span>
      </div>
    </div>
    <button @click="sendCommand('stop')" class="hud-btn hud-btn-danger text-xs">
      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
      STOP ALL
    </button>
  </div>

  <!-- Behavior cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">

    <!-- Patrol -->
    <div class="hud-panel rounded-xl p-5 behavior-card" :class="currentState === 'patrol' && 'active'" @click="sendCommand('patrol')">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/30 flex items-center justify-center">
          <svg class="w-6 h-6 text-cyan-400" :class="currentState === 'patrol' && 'spin-slow'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        </div>
        <div>
          <h3 class="text-white font-medium">Patrol</h3>
          <p class="text-xs text-slate-500">Cycle waypoints</p>
        </div>
      </div>
      <p class="text-xs text-slate-400 mb-3">Navigate between predefined waypoints in a continuous loop. Useful for surveillance and area monitoring.</p>
      <div x-show="currentState === 'patrol'" class="text-xs font-mono text-cyan-400/80 bg-slate-800/60 rounded px-2 py-1">
        Waypoint <span x-text="statusData.patrol_index + 1 || '?'"></span>/<span x-text="statusData.patrol_total || '?'"></span>
      </div>
    </div>

    <!-- Search -->
    <div class="hud-panel rounded-xl p-5 behavior-card" :class="currentState === 'search' && 'active'" @click="sendCommand('search')">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-lg bg-amber-500/10 border border-amber-500/30 flex items-center justify-center">
          <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
        <div>
          <h3 class="text-white font-medium">Search</h3>
          <p class="text-xs text-slate-500">Spiral explore</p>
        </div>
      </div>
      <p class="text-xs text-slate-400 mb-3">Expanding spiral search pattern from current position. Systematically covers the area looking for objects.</p>
      <div x-show="currentState === 'search'" class="text-xs font-mono text-amber-400/80 bg-slate-800/60 rounded px-2 py-1">
        Ring <span x-text="statusData.search_ring || '?'"></span>
      </div>
    </div>

    <!-- Follow -->
    <div class="hud-panel rounded-xl p-5 behavior-card" :class="currentState === 'follow' && 'active'" @click="startFollow()">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-lg bg-emerald-500/10 border border-emerald-500/30 flex items-center justify-center">
          <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </div>
        <div>
          <h3 class="text-white font-medium">Follow</h3>
          <p class="text-xs text-slate-500">Track target</p>
        </div>
      </div>
      <p class="text-xs text-slate-400 mb-3">Track and follow a detected target maintaining safe distance. Uses depth camera and vision detection.</p>
      <div x-show="currentState === 'follow'" class="text-xs font-mono text-emerald-400/80 bg-slate-800/60 rounded px-2 py-1">
        Target: <span x-text="statusData.follow_target || 'person'"></span>
        (<span x-text="statusData.follow_distance || '?'"></span>m)
      </div>
    </div>

    <!-- Guard -->
    <div class="hud-panel rounded-xl p-5 behavior-card" :class="currentState === 'guard' && 'active'" @click="sendCommand('guard')">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-lg bg-red-500/10 border border-red-500/30 flex items-center justify-center">
          <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <div>
          <h3 class="text-white font-medium">Guard</h3>
          <p class="text-xs text-slate-500">Monitor area</p>
        </div>
      </div>
      <p class="text-xs text-slate-400 mb-3">Station at current position and periodically scan surroundings. Returns to guard point if displaced.</p>
      <div x-show="currentState === 'guard'" class="text-xs font-mono text-red-400/80 bg-slate-800/60 rounded px-2 py-1">
        Scanning: <span x-text="['N','E','S','W'][statusData.guard_scan_direction] || '?'"></span>
      </div>
    </div>
  </div>

  <!-- Detail panels -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Robot Status -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Robot Position</h2>
      <div class="space-y-2">
        <div class="hud-data-row">
          <span class="text-sm text-slate-400">X</span>
          <span class="text-sm font-mono text-cyan-300" x-text="(statusData.robot_x || 0).toFixed(2) + ' m'"></span>
        </div>
        <div class="hud-data-row">
          <span class="text-sm text-slate-400">Y</span>
          <span class="text-sm font-mono text-cyan-300" x-text="(statusData.robot_y || 0).toFixed(2) + ' m'"></span>
        </div>
        <div class="hud-data-row">
          <span class="text-sm text-slate-400">Yaw</span>
          <span class="text-sm font-mono text-cyan-300" x-text="((statusData.robot_yaw || 0) * 180 / Math.PI).toFixed(1) + '\u00b0'"></span>
        </div>
        <template x-if="statusData.current_goal">
          <div class="mt-3 pt-3 border-t border-slate-700/50">
            <h3 class="text-xs font-semibold text-slate-500 mb-2">Current Goal</h3>
            <div class="hud-data-row">
              <span class="text-sm text-slate-400">Goal</span>
              <span class="text-sm font-mono text-cyan-300" x-text="'(' + statusData.current_goal.x + ', ' + statusData.current_goal.y + ')'"></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Patrol Waypoints -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Patrol Waypoints</h2>
      <div class="space-y-2">
        <template x-for="(wp, i) in patrolWaypoints" :key="i">
          <div class="flex items-center gap-2 text-sm bg-slate-800/40 rounded-lg p-2">
            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-mono"
                  :class="currentState === 'patrol' && (statusData.patrol_index || 0) === i ? 'bg-cyan-500/30 text-cyan-300 border border-cyan-500/50' : 'bg-slate-700/50 text-slate-500 border border-slate-600/50'"
                  x-text="i + 1"></span>
            <span class="text-slate-300 font-mono text-xs" x-text="'(' + wp[0] + ', ' + wp[1] + ') \u2192 ' + (wp[2] * 180 / Math.PI).toFixed(0) + '\u00b0'"></span>
          </div>
        </template>
      </div>
      <div class="mt-4 pt-3 border-t border-slate-700/50">
        <p class="text-xs text-slate-500 mb-2">Custom waypoint:</p>
        <div class="flex gap-2">
          <input type="number" x-model="newWpX" step="0.5" placeholder="X" class="hud-input w-16 text-xs py-1">
          <input type="number" x-model="newWpY" step="0.5" placeholder="Y" class="hud-input w-16 text-xs py-1">
          <input type="number" x-model="newWpYaw" step="0.5" placeholder="Yaw" class="hud-input w-16 text-xs py-1">
          <button @click="addWaypoint()" class="hud-btn hud-btn-primary text-xs py-1 px-2">Add</button>
        </div>
      </div>
    </div>

    <!-- Behavior Log -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Activity Log</h2>
      <div class="space-y-1 max-h-64 overflow-y-auto" x-ref="logScroll">
        <template x-for="(entry, i) in behaviorLog" :key="i">
          <div class="text-xs font-mono py-1 border-b border-slate-800/50"
               :class="entry.level === 'warn' ? 'text-amber-400' : entry.level === 'error' ? 'text-red-400' : 'text-slate-400'">
            <span class="text-slate-600" x-text="entry.time"></span>
            <span x-text="entry.msg"></span>
          </div>
        </template>
        <template x-if="behaviorLog.length === 0">
          <p class="text-xs text-slate-600">No activity yet. Select a behavior to begin.</p>
        </template>
      </div>
    </div>
  </div>

  <!-- Follow target input dialog -->
  <div x-show="showFollowDialog" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80" @click.self="showFollowDialog = false">
    <div class="hud-panel rounded-xl p-6 w-80">
      <h3 class="text-white font-medium mb-4">Follow Target</h3>
      <input type="text" x-model="followTarget" placeholder="Target label (e.g., person, cat)" class="hud-input w-full mb-4">
      <div class="flex gap-2">
        <button @click="sendCommand('follow@' + followTarget); showFollowDialog = false" class="hud-btn hud-btn-primary flex-1 text-xs">Start Following</button>
        <button @click="showFollowDialog = false" class="hud-btn hud-btn-secondary flex-1 text-xs">Cancel</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function behaviorsApp() {
  return {
    ws: null,
    connected: false,
    currentState: 'idle',
    timeInState: 0,
    statusData: {},
    behaviorLog: [],
    showFollowDialog: false,
    followTarget: 'person',

    // Patrol waypoints (default, matches behavior_manager_node)
    patrolWaypoints: [
      [2.0, 0.0, 0.0],
      [2.0, 2.0, 1.57],
      [0.0, 2.0, 3.14],
      [0.0, 0.0, -1.57],
    ],
    newWpX: 0, newWpY: 0, newWpYaw: 0,

    init() {
      this.connectWs();
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws/behaviors/`);
      this.ws.onopen = () => { this.connected = true; this.log('Connected to behavior manager'); };
      this.ws.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.type === 'behavior_status' && msg.data) {
            const prev = this.currentState;
            this.statusData = msg.data;
            this.currentState = msg.data.state || 'idle';
            this.timeInState = msg.data.time_in_state || 0;
            if (prev !== this.currentState) {
              this.log(`State changed: ${prev} \u2192 ${this.currentState}`);
            }
          }
        } catch(err) {}
      };
      this.ws.onclose = () => {
        this.connected = false;
        setTimeout(() => this.connectWs(), 5000);
      };
      this.ws.onerror = () => { this.connected = false; };
    },

    sendCommand(cmd) {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ command: cmd }));
        this.log(`Sent command: ${cmd}`);
      } else {
        this.log('Not connected', 'warn');
      }
    },

    startFollow() {
      this.showFollowDialog = true;
    },

    addWaypoint() {
      const x = parseFloat(this.newWpX) || 0;
      const y = parseFloat(this.newWpY) || 0;
      const yaw = parseFloat(this.newWpYaw) || 0;
      this.patrolWaypoints.push([x, y, yaw]);
      this.log(`Added waypoint: (${x}, ${y}, ${yaw})`);
    },

    log(msg, level = 'info') {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      this.behaviorLog.unshift({ time, msg, level });
      if (this.behaviorLog.length > 100) this.behaviorLog.pop();
    },
  }
}
</script>
{% endblock %}
