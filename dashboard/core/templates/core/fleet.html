{% extends "core/base.html" %}
{% block title %}Fleet{% endblock %}
{% block page_title %}Fleet Overview{% endblock %}

{% block help_modal %}
<div id="helpModal" class="hidden fixed inset-0 z-50 hud-modal-backdrop flex items-start justify-center pt-20 px-4" onclick="if(event.target===this)this.classList.add('hidden')">
  <div class="hud-modal rounded-2xl max-w-2xl w-full max-h-[75vh] overflow-y-auto p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-white tracking-tight">Fleet Overview Documentation</h2>
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-slate-500 hover:text-white transition-colors text-xl leading-none">&times;</button>
    </div>

    <div class="doc-section">
      <h3>Overview</h3>
      <p>The Fleet page provides auto-discovery and monitoring of multiple BillyBot robots operating on the same ROS 2 DDS network. Robots are identified by their ROS 2 namespace prefix.</p>
      <p>Data refreshes every <code>15 seconds</code> via <code>/api/fleet/robots/</code> which scans <code>ros2 node list</code> and groups nodes by namespace.</p>
    </div>

    <div class="doc-section">
      <h3>Namespace Convention</h3>
      <p>Each robot operates under a unique namespace that prefixes all its nodes and topics:</p>
      <dl class="doc-grid">
        <dt>/grunt1/</dt>
        <dd>Primary robot. Default namespace for single-robot operation.</dd>
        <dt>/grunt2/</dt>
        <dd>Second robot in the fleet.</dd>
        <dt>/gruntN/</dt>
        <dd>Additional robots follow the same pattern.</dd>
      </dl>
      <div class="info-box mt-3">
        <p><strong>Launch with namespace:</strong></p>
        <p class="mt-1"><code>ros2 launch by_your_command hardware.launch.py namespace:=grunt2</code></p>
        <p class="mt-1">Or manually: <code>ros2 run pkg node --ros-args -r __ns:=/grunt2</code></p>
      </div>
    </div>

    <div class="doc-section">
      <h3>Robot Discovery</h3>
      <p>The fleet API works by parsing the output of <code>ros2 node list</code> and grouping nodes by their first path component:</p>
      <dl class="doc-grid">
        <dt>Namespaced nodes</dt>
        <dd>Nodes like <code>/grunt1/ddsm_driver_node</code> are grouped under the <code>grunt1</code> robot.</dd>
        <dt>Standalone nodes</dt>
        <dd>Nodes without a namespace prefix (e.g., <code>/rosout</code>) appear in the &ldquo;Standalone Nodes&rdquo; section.</dd>
        <dt>Topic grouping</dt>
        <dd>Topics are associated with robots if they share the same namespace prefix.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Per-Robot Topics</h3>
      <p>Each robot exposes its own set of namespaced topics:</p>
      <dl class="doc-grid">
        <dt>/gruntN/cmd_vel</dt>
        <dd>Movement commands (Twist) for this specific robot.</dd>
        <dt>/gruntN/odom</dt>
        <dd>Odometry from this robot&rsquo;s wheel encoders.</dd>
        <dt>/gruntN/arm_preset</dt>
        <dd>Arm position commands for this robot&rsquo;s servo arm.</dd>
        <dt>/gruntN/behavior_command</dt>
        <dd>Behavior triggers (patrol, search, follow, guard, stop).</dd>
        <dt>/gruntN/motor_feedback</dt>
        <dd>Motor telemetry from this robot&rsquo;s DDSM driver.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Robot Cards</h3>
      <p>Each discovered robot is displayed as a card showing:</p>
      <dl class="doc-grid">
        <dt>Namespace</dt>
        <dd>The robot&rsquo;s unique identifier (e.g., /grunt1).</dd>
        <dt>Node Count</dt>
        <dd>Number of active ROS 2 nodes under this namespace.</dd>
        <dt>Topic Count</dt>
        <dd>Number of topics associated with this robot.</dd>
        <dt>Node List</dt>
        <dd>Up to 8 active nodes shown. Excess nodes indicated with &ldquo;+ N more&rdquo;.</dd>
        <dt>Quick Links</dt>
        <dd><strong>Control</strong> and <strong>Telemetry</strong> buttons link to the respective pages with the namespace as a query parameter.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>DDS Discovery</h3>
      <p>Robot discovery relies on ROS 2 DDS (Data Distribution Service) multicast discovery:</p>
      <dl class="doc-grid">
        <dt>RMW</dt>
        <dd>CycloneDDS (<code>rmw_cyclonedds_cpp</code>). Configured via <code>RMW_IMPLEMENTATION</code> environment variable.</dd>
        <dt>Domain ID</dt>
        <dd>All robots must share the same <code>ROS_DOMAIN_ID</code> (default: 0) to discover each other.</dd>
        <dt>Network</dt>
        <dd>Docker <code>network_mode: host</code> ensures DDS multicast works across containers.</dd>
        <dt>Shared Memory</dt>
        <dd><code>/dev/shm</code> is mounted for CycloneDDS zero-copy transport between local containers.</dd>
      </dl>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
  .hud-panel { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(6, 182, 212, 0.2); }
  .hud-panel:hover { border-color: rgba(6, 182, 212, 0.35); }
  .robot-card { transition: all 0.3s; }
  .robot-card:hover { transform: translateY(-2px); border-color: rgba(6, 182, 212, 0.5); }
</style>
{% endblock %}

{% block content %}
<div x-data="fleetApp()" x-init="init()">

  <!-- Fleet summary bar -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div class="flex items-center gap-6 flex-wrap">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-bold text-white" x-text="robots.length"></span>
        <span class="text-sm text-slate-400">robots</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-lg font-mono text-cyan-300" x-text="totalNodes"></span>
        <span class="text-sm text-slate-400">nodes</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-lg font-mono text-cyan-300" x-text="totalTopics"></span>
        <span class="text-sm text-slate-400">topics</span>
      </div>
    </div>
    <button @click="refresh()" class="hud-btn hud-btn-secondary text-xs">
      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
      Refresh
    </button>
  </div>

  <!-- Robot cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <template x-for="robot in robots" :key="robot.namespace">
      <div class="hud-panel rounded-xl p-5 robot-card">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/30 flex items-center justify-center">
              <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold" x-text="'/' + robot.namespace"></h3>
              <p class="text-xs text-slate-500" x-text="robot.nodes.length + ' nodes, ' + robot.topics.length + ' topics'"></p>
            </div>
          </div>
          <span class="w-3 h-3 rounded-full bg-emerald-500 pulse-dot"></span>
        </div>

        <!-- Nodes list -->
        <div class="space-y-1 mb-3">
          <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Nodes</h4>
          <template x-for="node in robot.nodes.slice(0, 8)" :key="node">
            <div class="flex items-center gap-2 text-xs">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-500/60"></span>
              <span class="text-slate-300 font-mono" x-text="node"></span>
            </div>
          </template>
          <template x-if="robot.nodes.length > 8">
            <p class="text-xs text-slate-600" x-text="'+ ' + (robot.nodes.length - 8) + ' more...'"></p>
          </template>
        </div>

        <!-- Quick actions -->
        <div class="flex gap-2 pt-3 border-t border-slate-700/50">
          <a :href="'/control/?ns=' + robot.namespace" class="hud-btn hud-btn-primary text-xs py-1 flex-1 text-center">Control</a>
          <a :href="'/telemetry/?ns=' + robot.namespace" class="hud-btn hud-btn-secondary text-xs py-1 flex-1 text-center">Telemetry</a>
        </div>
      </div>
    </template>

    <!-- No robots found -->
    <template x-if="robots.length === 0 && !loading">
      <div class="hud-panel rounded-xl p-8 text-center col-span-full">
        <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        <h3 class="text-white font-medium mb-2">No Robots Discovered</h3>
        <p class="text-sm text-slate-500 mb-4">No namespaced ROS 2 nodes found. Robots using namespaces like <code class="text-cyan-400">/grunt1/</code> will appear here.</p>
        <p class="text-xs text-slate-600">Launch with namespace: <code class="text-cyan-400/70">ros2 launch by_your_command hardware.launch.py namespace:=grunt1</code></p>
      </div>
    </template>
  </div>

  <!-- Standalone nodes (not in any namespace) -->
  <div class="hud-panel rounded-xl p-5" x-show="standaloneNodes.length > 0">
    <h2 class="hud-section-title">Standalone Nodes (No Namespace)</h2>
    <div class="flex flex-wrap gap-2">
      <template x-for="node in standaloneNodes" :key="node">
        <span class="text-xs font-mono px-2 py-1 rounded bg-slate-800/60 text-slate-400 border border-slate-700/50" x-text="node"></span>
      </template>
    </div>
    <p class="text-xs text-slate-600 mt-3">These nodes are not under a robot namespace. For fleet operation, use <code class="text-cyan-400/70">--ros-args -r __ns:=/grunt1</code></p>
  </div>

  <!-- Fleet architecture info -->
  <div class="mt-6 hud-panel rounded-xl p-5">
    <h2 class="hud-section-title">Fleet Architecture</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="text-sm text-white font-medium mb-2">Namespace Convention</h3>
        <div class="space-y-1 text-xs text-slate-400 font-mono">
          <p>/grunt1/ - Robot 1 (primary)</p>
          <p>/grunt2/ - Robot 2</p>
          <p>/grunt3/ - Robot 3</p>
        </div>
      </div>
      <div>
        <h3 class="text-sm text-white font-medium mb-2">Per-Robot Topics</h3>
        <div class="space-y-1 text-xs text-slate-400 font-mono">
          <p>/gruntN/cmd_vel</p>
          <p>/gruntN/odom</p>
          <p>/gruntN/arm_preset</p>
          <p>/gruntN/behavior_command</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function fleetApp() {
  return {
    robots: [],
    standaloneNodes: [],
    totalNodes: 0,
    totalTopics: 0,
    loading: false,

    init() {
      this.refresh();
      setInterval(() => this.refresh(), 15000);
    },

    async refresh() {
      this.loading = true;
      try {
        const resp = await fetch('/api/fleet/robots/');
        const data = await resp.json();
        this.robots = data.robots || [];
        this.standaloneNodes = data.standalone_nodes || [];
        this.totalNodes = data.total_nodes || 0;
        this.totalTopics = data.total_topics || 0;
      } catch(e) {
        console.error('Fleet refresh failed:', e);
      } finally {
        this.loading = false;
      }
    },
  }
}
</script>
{% endblock %}
