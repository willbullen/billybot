{% extends "core/base.html" %}
{% block title %}Fleet{% endblock %}
{% block page_title %}Fleet Overview{% endblock %}

{% block extra_head %}
<style>
  .hud-panel { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(6, 182, 212, 0.2); }
  .hud-panel:hover { border-color: rgba(6, 182, 212, 0.35); }
  .robot-card { transition: all 0.3s; }
  .robot-card:hover { transform: translateY(-2px); border-color: rgba(6, 182, 212, 0.5); }
</style>
{% endblock %}

{% block content %}
<div x-data="fleetApp()" x-init="init()">

  <!-- Fleet summary bar -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div class="flex items-center gap-6 flex-wrap">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-bold text-white" x-text="robots.length"></span>
        <span class="text-sm text-slate-400">robots</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-lg font-mono text-cyan-300" x-text="totalNodes"></span>
        <span class="text-sm text-slate-400">nodes</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-lg font-mono text-cyan-300" x-text="totalTopics"></span>
        <span class="text-sm text-slate-400">topics</span>
      </div>
    </div>
    <button @click="refresh()" class="hud-btn hud-btn-secondary text-xs">
      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
      Refresh
    </button>
  </div>

  <!-- Robot cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <template x-for="robot in robots" :key="robot.namespace">
      <div class="hud-panel rounded-xl p-5 robot-card">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-cyan-500/10 border border-cyan-500/30 flex items-center justify-center">
              <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold" x-text="'/' + robot.namespace"></h3>
              <p class="text-xs text-slate-500" x-text="robot.nodes.length + ' nodes, ' + robot.topics.length + ' topics'"></p>
            </div>
          </div>
          <span class="w-3 h-3 rounded-full bg-emerald-500 pulse-dot"></span>
        </div>

        <!-- Nodes list -->
        <div class="space-y-1 mb-3">
          <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Nodes</h4>
          <template x-for="node in robot.nodes.slice(0, 8)" :key="node">
            <div class="flex items-center gap-2 text-xs">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-500/60"></span>
              <span class="text-slate-300 font-mono" x-text="node"></span>
            </div>
          </template>
          <template x-if="robot.nodes.length > 8">
            <p class="text-xs text-slate-600" x-text="'+ ' + (robot.nodes.length - 8) + ' more...'"></p>
          </template>
        </div>

        <!-- Quick actions -->
        <div class="flex gap-2 pt-3 border-t border-slate-700/50">
          <a :href="'/control/?ns=' + robot.namespace" class="hud-btn hud-btn-primary text-xs py-1 flex-1 text-center">Control</a>
          <a :href="'/telemetry/?ns=' + robot.namespace" class="hud-btn hud-btn-secondary text-xs py-1 flex-1 text-center">Telemetry</a>
        </div>
      </div>
    </template>

    <!-- No robots found -->
    <template x-if="robots.length === 0 && !loading">
      <div class="hud-panel rounded-xl p-8 text-center col-span-full">
        <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        <h3 class="text-white font-medium mb-2">No Robots Discovered</h3>
        <p class="text-sm text-slate-500 mb-4">No namespaced ROS 2 nodes found. Robots using namespaces like <code class="text-cyan-400">/grunt1/</code> will appear here.</p>
        <p class="text-xs text-slate-600">Launch with namespace: <code class="text-cyan-400/70">ros2 launch by_your_command hardware.launch.py namespace:=grunt1</code></p>
      </div>
    </template>
  </div>

  <!-- Standalone nodes (not in any namespace) -->
  <div class="hud-panel rounded-xl p-5" x-show="standaloneNodes.length > 0">
    <h2 class="hud-section-title">Standalone Nodes (No Namespace)</h2>
    <div class="flex flex-wrap gap-2">
      <template x-for="node in standaloneNodes" :key="node">
        <span class="text-xs font-mono px-2 py-1 rounded bg-slate-800/60 text-slate-400 border border-slate-700/50" x-text="node"></span>
      </template>
    </div>
    <p class="text-xs text-slate-600 mt-3">These nodes are not under a robot namespace. For fleet operation, use <code class="text-cyan-400/70">--ros-args -r __ns:=/grunt1</code></p>
  </div>

  <!-- Fleet architecture info -->
  <div class="mt-6 hud-panel rounded-xl p-5">
    <h2 class="hud-section-title">Fleet Architecture</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="text-sm text-white font-medium mb-2">Namespace Convention</h3>
        <div class="space-y-1 text-xs text-slate-400 font-mono">
          <p>/grunt1/ - Robot 1 (primary)</p>
          <p>/grunt2/ - Robot 2</p>
          <p>/grunt3/ - Robot 3</p>
        </div>
      </div>
      <div>
        <h3 class="text-sm text-white font-medium mb-2">Per-Robot Topics</h3>
        <div class="space-y-1 text-xs text-slate-400 font-mono">
          <p>/gruntN/cmd_vel</p>
          <p>/gruntN/odom</p>
          <p>/gruntN/arm_preset</p>
          <p>/gruntN/behavior_command</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function fleetApp() {
  return {
    robots: [],
    standaloneNodes: [],
    totalNodes: 0,
    totalTopics: 0,
    loading: false,

    init() {
      this.refresh();
      setInterval(() => this.refresh(), 15000);
    },

    async refresh() {
      this.loading = true;
      try {
        const resp = await fetch('/api/fleet/robots/');
        const data = await resp.json();
        this.robots = data.robots || [];
        this.standaloneNodes = data.standalone_nodes || [];
        this.totalNodes = data.total_nodes || 0;
        this.totalTopics = data.total_topics || 0;
      } catch(e) {
        console.error('Fleet refresh failed:', e);
      } finally {
        this.loading = false;
      }
    },
  }
}
</script>
{% endblock %}
