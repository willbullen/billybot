{% extends "core/base.html" %}
{% block title %}Nodes{% endblock %}
{% block page_title %}Nodes Manager{% endblock %}

{% block content %}
<div x-data="nodesApp()" x-init="init()">

  <!-- Toolbar -->
  <div class="flex items-center justify-between mb-6">
    <button @click="refresh()" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm text-white transition-colors">Refresh</button>
    <span class="text-sm text-slate-500" x-text="nodeList.length + ' nodes active'"></span>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Nodes list -->
    <div class="glass rounded-xl p-5">
      <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">Active Nodes</h2>
      <div class="space-y-1 max-h-[600px] overflow-y-auto">
        <template x-for="node in nodeList" :key="node">
          <button @click="selectNode(node)"
                  class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-sm transition-colors"
                  :class="selectedNode === node ? 'bg-brand-600/20 text-brand-300 ring-1 ring-brand-500/30' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/50'">
            <span class="w-2 h-2 rounded-full bg-emerald-500 shrink-0"></span>
            <span class="font-mono truncate" x-text="node"></span>
          </button>
        </template>
        <div x-show="nodeList.length === 0" class="text-sm text-slate-500 text-center py-8">No nodes found</div>
      </div>
    </div>

    <!-- Node detail -->
    <div class="glass rounded-xl p-5">
      <template x-if="selectedNode">
        <div>
          <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-2">Node Info</h2>
          <div class="font-mono text-brand-400 text-sm mb-4" x-text="selectedNode"></div>

          <div x-show="nodeInfoLoading" class="text-sm text-slate-500 text-center py-8">Loading node info...</div>

          <div x-show="!nodeInfoLoading && nodeInfo">
            <!-- Raw info -->
            <div class="p-3 rounded-lg bg-slate-900 border border-slate-700 font-mono text-xs text-slate-300 whitespace-pre-wrap max-h-80 overflow-y-auto" x-text="nodeInfo"></div>

            <!-- Parameters section -->
            <div class="mt-4" x-show="nodeParams.length > 0">
              <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Parameters</h3>
              <div class="space-y-1 max-h-60 overflow-y-auto">
                <template x-for="param in nodeParams" :key="param">
                  <div class="flex items-center justify-between px-3 py-2 rounded bg-slate-800/50 text-sm">
                    <span class="font-mono text-slate-300 truncate" x-text="param"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </template>
      <template x-if="!selectedNode">
        <div class="flex items-center justify-center h-64 text-slate-500 text-sm">
          Select a node to view details
        </div>
      </template>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function nodesApp() {
  return {
    nodeList: [],
    selectedNode: null,
    nodeInfo: '',
    nodeParams: [],
    nodeInfoLoading: false,

    async init() { await this.refresh(); },

    async refresh() {
      try {
        const r = await fetch('/api/ros2/nodes/');
        const data = await r.json();
        this.nodeList = data.nodes || [];
      } catch(e) { this.nodeList = []; }
    },

    async selectNode(node) {
      this.selectedNode = node;
      this.nodeInfoLoading = true;
      this.nodeInfo = '';
      this.nodeParams = [];
      try {
        const r = await fetch(`/api/ros2/node-info/?node=${encodeURIComponent(node)}`);
        const data = await r.json();
        this.nodeInfo = data.output || '';
        this.nodeParams = data.params || [];
      } catch(e) {
        this.nodeInfo = `Error: ${e.message}`;
      }
      this.nodeInfoLoading = false;
    }
  }
}
</script>
{% endblock %}
