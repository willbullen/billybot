{% extends "core/base.html" %}
{% block title %}Settings{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div x-data="settingsApp()" x-init="init()">

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Container status with health -->
    <div class="hud-panel rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="hud-section-title mb-0">Containers</h2>
        <button @click="fetchContainers()" class="hud-btn hud-btn-secondary text-xs !py-1">Refresh</button>
      </div>
      <div class="space-y-3">
        <template x-for="c in containers" :key="c.name">
          <div class="hud-data-row">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium text-white" x-text="c.label"></div>
              <div class="text-xs text-slate-500 font-mono truncate" x-text="c.name"></div>
              <div class="text-xs mt-0.5" :class="c.running ? 'text-emerald-400/70' : 'text-red-400/70'" x-text="c.status"></div>
            </div>
            <div class="flex items-center gap-3 shrink-0">
              <span class="w-2 h-2 rounded-full" :class="c.running ? 'bg-emerald-500 pulse-dot' : 'bg-red-500'"></span>
              <button @click="restartContainer(c.name)"
                      class="hud-btn hud-btn-warning text-xs !px-3 !py-1.5">
                Restart
              </button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- System health -->
    <div class="hud-panel rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="hud-section-title mb-0">System Health</h2>
        <span class="text-xs font-mono px-2 py-0.5 rounded-full border"
              :class="systemHealth.overall === 'healthy' ? 'text-emerald-400 border-emerald-500/30 bg-emerald-500/10' :
                       systemHealth.overall === 'degraded' ? 'text-amber-400 border-amber-500/30 bg-amber-500/10' :
                       'text-red-400 border-red-500/30 bg-red-500/10'"
              x-text="(systemHealth.overall || 'checking').toUpperCase()"></span>
      </div>
      <div class="space-y-2">
        <div class="hud-data-row text-sm">
          <span class="text-slate-400">Dashboard Uptime</span>
          <span class="text-cyan-300 font-mono" x-text="formatUptime(systemHealth.dashboard?.uptime || 0)"></span>
        </div>
        <div class="hud-data-row text-sm">
          <span class="text-slate-400">ROS 2 Nodes</span>
          <span class="text-cyan-300 font-mono" x-text="(systemHealth.ros2?.nodes || []).length"></span>
        </div>
        <div class="hud-data-row text-sm">
          <span class="text-slate-400">ROS 2 Topics</span>
          <span class="text-cyan-300 font-mono" x-text="systemHealth.ros2?.topics_count || 0"></span>
        </div>
        <div class="hud-data-row text-sm">
          <span class="text-slate-400">Containers Running</span>
          <span class="text-cyan-300 font-mono" x-text="(systemHealth.containers || []).filter(c => c.running).length + '/' + (systemHealth.containers || []).length"></span>
        </div>
      </div>
      <!-- Active ROS nodes -->
      <div class="mt-4 pt-3 border-t border-slate-700/50">
        <h3 class="text-xs font-semibold text-slate-500 mb-2">Active Nodes</h3>
        <div class="max-h-32 overflow-y-auto space-y-1">
          <template x-for="node in (systemHealth.ros2?.nodes || [])" :key="node">
            <div class="flex items-center gap-2 text-xs">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
              <span class="font-mono text-cyan-400/70" x-text="node"></span>
            </div>
          </template>
          <p x-show="!(systemHealth.ros2?.nodes || []).length" class="text-xs text-slate-600">No ROS nodes detected</p>
        </div>
      </div>
    </div>

    <!-- Launch configurations -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Launch Configurations</h2>
      <div class="space-y-2">
        <template x-for="launch in launches" :key="launch.file">
          <div class="hud-data-row flex-col !items-start gap-1">
            <div class="text-sm font-mono text-cyan-300" x-text="launch.file"></div>
            <div class="text-xs text-slate-500" x-text="launch.description"></div>
          </div>
        </template>
      </div>
    </div>

    <!-- Environment & System info -->
    <div class="space-y-6">
      <div class="hud-panel rounded-xl p-5">
        <h2 class="hud-section-title">System Info</h2>
        <div class="space-y-2">
          <div class="hud-data-row text-sm">
            <span class="text-slate-400">ROS 2 Version</span>
            <span class="text-cyan-300">Humble</span>
          </div>
          <div class="hud-data-row text-sm">
            <span class="text-slate-400">ROS Domain ID</span>
            <span class="text-cyan-300 font-mono">{{ ros_domain_id }}</span>
          </div>
          <div class="hud-data-row text-sm">
            <span class="text-slate-400">DDS Middleware</span>
            <span class="text-cyan-300">CycloneDDS</span>
          </div>
          <div class="hud-data-row text-sm">
            <span class="text-slate-400">Bridge WebSocket</span>
            <span class="text-cyan-300 font-mono">{{ ros2_bridge_ws }}</span>
          </div>
          <div class="hud-data-row text-sm">
            <span class="text-slate-400">Dashboard</span>
            <span class="text-cyan-300">Django + Channels + Daphne</span>
          </div>
        </div>
      </div>

      <div class="hud-panel rounded-xl p-5">
        <h2 class="hud-section-title">Environment</h2>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          <template x-for="(v, k) in envVars" :key="k">
            <div class="hud-data-row text-sm">
              <span class="font-mono text-cyan-400/60 truncate" x-text="k"></span>
              <span class="font-mono text-slate-300 truncate ml-2" x-text="v"></span>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- Deployment controls -->
  <div class="mt-6 hud-panel rounded-xl p-5">
    <h2 class="hud-section-title">Deployment</h2>
    <div class="flex flex-wrap gap-3 mb-4">
      <button @click="deploy('build')" :disabled="deploying"
              class="hud-btn hud-btn-primary" :class="deploying && 'opacity-50'">
        <span x-text="deploying ? 'Deploying...' : 'Build & Deploy'"></span>
      </button>
      <button @click="deploy('pull')" :disabled="deploying"
              class="hud-btn hud-btn-secondary" :class="deploying && 'opacity-50'">
        Pull & Deploy
      </button>
      <button @click="deploy('rollback')" :disabled="deploying"
              class="hud-btn hud-btn-danger" :class="deploying && 'opacity-50'">
        Rollback
      </button>
    </div>
    <div x-show="deployResult" class="bg-slate-800/60 rounded-lg border border-slate-700/50 p-3">
      <pre class="text-xs font-mono text-slate-300 whitespace-pre-wrap max-h-48 overflow-y-auto" x-text="deployResult"></pre>
    </div>
  </div>

  <div x-show="actionResult" class="mt-4 hud-panel rounded-xl p-4">
    <div class="text-sm font-mono text-slate-300 whitespace-pre-wrap" x-text="actionResult"></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function settingsApp() {
  return {
    containers: [],
    envVars: {},
    actionResult: '',
    systemHealth: {},
    deploying: false,
    deployResult: '',
    launches: [
      { file: 'oai_realtime.launch.py', description: 'OpenAI Realtime - Voice-only conversation' },
      { file: 'oai_dual_agent.launch.py', description: 'OpenAI Dual Agent - Voice + command extraction' },
      { file: 'gemini_live.launch.py', description: 'Gemini Live - Voice with optional video' },
      { file: 'gemini_dual_agent.launch.py', description: 'Gemini Dual Agent - Full multimodal' },
      { file: 'gemini_vision.launch.py', description: 'Gemini Vision - Vision-focused queries' },
      { file: 'gemini_single.launch.py', description: 'Gemini Single Agent - Single-agent mode' },
      { file: 'byc.launch.py', description: 'Basic - Audio pipeline only (testing)' },
      { file: 'hardware.launch.py', description: 'Hardware - URDF + DDSM motors + ST3215 servos' },
      { file: 'camera.launch.py', description: 'Camera - RealSense driver (simulate:=true for dev)' },
      { file: 'navigation.launch.py', description: 'Navigation - Hardware + Camera + SLAM + Nav2' },
    ],

    async init() {
      await Promise.all([this.fetchContainers(), this.fetchHealth()]);
      this.envVars = {
        'ROS_DOMAIN_ID': '{{ ros_domain_id }}',
        'RMW_IMPLEMENTATION': 'rmw_cyclonedds_cpp',
        'ROS2_BRIDGE_WS': '{{ ros2_bridge_ws }}',
        'OPENAI_API_KEY': '***masked***',
        'GOOGLE_API_KEY': '***masked***',
      };
      // Refresh health every 15s
      setInterval(() => this.fetchHealth(), 15000);
    },

    async fetchContainers() {
      try {
        const r = await fetch('/api/docker/containers/');
        const data = await r.json();
        this.containers = data.containers || [];
      } catch(e) { this.containers = []; }
    },

    async fetchHealth() {
      try {
        const r = await fetch('/api/system/health/');
        this.systemHealth = await r.json();
      } catch(e) { this.systemHealth = { overall: 'unknown' }; }
    },

    async restartContainer(name) {
      this.actionResult = `Restarting ${name}...`;
      try {
        const r = await fetch('/api/docker/restart/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ container: name })
        });
        const data = await r.json();
        this.actionResult = data.result || data.error || 'Done';
        await this.fetchContainers();
      } catch(e) {
        this.actionResult = `Error: ${e.message}`;
      }
    },

    async deploy(mode) {
      this.deploying = true;
      this.deployResult = `Starting ${mode} deployment...`;
      try {
        // Use the ROS exec endpoint to trigger deploy on the host
        // In production, this would be a dedicated deploy endpoint
        const r = await fetch('/api/ros2/exec/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ command: `echo "Deploy mode: ${mode} - Use scripts/deploy.sh --${mode} on the host"` })
        });
        const data = await r.json();
        this.deployResult = data.output || 'Deploy triggered. Check host for progress.\n\nRun on host:\n  ./scripts/deploy.sh' + (mode !== 'build' ? ` --${mode}` : '');
      } catch(e) {
        this.deployResult = `Error: ${e.message}`;
      }
      this.deploying = false;
    },

    formatUptime(seconds) {
      if (!seconds) return '0s';
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (d > 0) return `${d}d ${h}h ${m}m`;
      if (h > 0) return `${h}h ${m}m ${s}s`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    },
  }
}
</script>
{% endblock %}
