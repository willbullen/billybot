{% extends "core/base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block help_modal %}
<div id="helpModal" class="hidden fixed inset-0 z-50 hud-modal-backdrop flex items-start justify-center pt-20 px-4" onclick="if(event.target===this)this.classList.add('hidden')">
  <div class="hud-modal rounded-2xl max-w-2xl w-full max-h-[75vh] overflow-y-auto p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-white tracking-tight">Dashboard Documentation</h2>
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-slate-500 hover:text-white transition-colors text-xl leading-none">&times;</button>
    </div>

    <div class="doc-section">
      <h3>Overview</h3>
      <p>The Dashboard is your primary operational overview of the entire BillyBot system. It aggregates real-time status from all Docker containers, active ROS 2 nodes, and running topics into a single, glanceable interface.</p>
      <p>Data refreshes automatically every <code>10 seconds</code> via REST API polling against <code>/api/docker/containers/</code>, <code>/api/ros2/nodes/</code>, and <code>/api/ros2/topics/</code>.</p>
    </div>

    <div class="doc-section">
      <h3>Status Cards</h3>
      <p>The top row displays four aggregated metrics:</p>
      <dl class="doc-grid">
        <dt>Containers</dt>
        <dd>Count of billybot-* Docker containers currently running vs total. Green = all running. Yellow = partial. Red = none running.</dd>
        <dt>ROS 2 Nodes</dt>
        <dd>Total number of active ROS 2 nodes discovered via <code>ros2 node list</code> inside the billybot-ros2 container.</dd>
        <dt>Topics</dt>
        <dd>Active ROS 2 topic count from <code>ros2 topic list</code>. Includes system topics (/rosout, /parameter_events).</dd>
        <dt>System Health</dt>
        <dd>Composite health indicator based on container status and node availability. Maps to OPERATIONAL / DEGRADED / OFFLINE.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Docker Containers</h3>
      <p>Lists all BillyBot containers with their current state and uptime:</p>
      <dl class="doc-grid">
        <dt>billybot-ros2</dt>
        <dd>ROS 2 Humble + ByYourCommand voice/AI pipeline. Contains all ROS nodes, audio processing, and AI agents.</dd>
        <dt>billybot-nanobot</dt>
        <dd>Nanobot AI assistant gateway. Multi-channel bot (Telegram, Slack, Discord) with ROS 2 management tool.</dd>
        <dt>billybot-dashboard</dt>
        <dd>This Django + Channels web dashboard. Daphne ASGI server on port 8000.</dd>
        <dt>billybot-redis</dt>
        <dd>Redis 7 channel layer for Django Channels WebSocket support.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Quick Actions</h3>
      <p>Bottom action buttons link directly to key operational pages. The activity log shows the last 20 system events including container state changes and node launches.</p>
    </div>

    <div class="doc-section">
      <h3>Architecture</h3>
      <div class="info-box">
        <p class="font-mono text-xs leading-relaxed">docker-compose.yml<br>
        &nbsp;&nbsp;ros2-byc &rarr; billybot-ros2 (ROS 2 + voice + AI agents)<br>
        &nbsp;&nbsp;nanobot &rarr; billybot-nanobot (AI assistant gateway)<br>
        &nbsp;&nbsp;dashboard &rarr; billybot-dashboard (Django + WebSocket)<br>
        &nbsp;&nbsp;redis &rarr; billybot-redis (channel layer)</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div x-data="dashboardApp()" x-init="init()">

  <!-- Status cards row -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Container statuses -->
    <template x-for="c in containers" :key="c.name">
      <div class="hud-panel rounded-xl p-5 hud-glow">
        <div class="flex items-center justify-between mb-3">
          <span class="text-xs font-semibold text-cyan-400/70 uppercase tracking-wider" x-text="c.label"></span>
          <span class="w-2.5 h-2.5 rounded-full" :class="c.running ? 'bg-emerald-500 pulse-dot' : 'bg-red-500'"></span>
        </div>
        <div class="text-2xl font-bold" :class="c.running ? 'text-emerald-400' : 'text-red-400'" x-text="c.running ? 'Running' : 'Stopped'"></div>
        <div class="text-xs text-slate-500 mt-1 font-mono" x-text="c.status"></div>
      </div>
    </template>

    <!-- Node count -->
    <div class="hud-panel rounded-xl p-5 hud-glow">
      <div class="flex items-center justify-between mb-3">
        <span class="text-xs font-semibold text-cyan-400/70 uppercase tracking-wider">ROS 2 Nodes</span>
        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
      </div>
      <div class="text-2xl font-bold text-cyan-300" x-text="nodeCount"></div>
      <div class="text-xs text-slate-500 mt-1">Active nodes</div>
    </div>

    <!-- Topic count -->
    <div class="hud-panel rounded-xl p-5 hud-glow">
      <div class="flex items-center justify-between mb-3">
        <span class="text-xs font-semibold text-cyan-400/70 uppercase tracking-wider">Topics</span>
        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      </div>
      <div class="text-2xl font-bold text-cyan-300" x-text="topicCount"></div>
      <div class="text-xs text-slate-500 mt-1">Active topics</div>
    </div>
  </div>

  <!-- Two column layout -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Nodes list -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Active Nodes</h2>
      <div class="space-y-2 max-h-80 overflow-y-auto">
        <template x-for="node in nodeList" :key="node">
          <div class="hud-data-row">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 rounded-full bg-emerald-500 shrink-0"></span>
              <span class="text-sm font-mono text-slate-300 truncate" x-text="node"></span>
            </div>
          </div>
        </template>
        <div x-show="nodeList.length === 0" class="text-sm text-slate-500 text-center py-4">No nodes detected</div>
      </div>
    </div>

    <!-- Activity log -->
    <div class="hud-panel rounded-xl p-5">
      <h2 class="hud-section-title">Activity Log</h2>
      <div class="space-y-2 max-h-80 overflow-y-auto" id="activity-log">
        <template x-for="(entry, i) in activityLog" :key="i">
          <div class="hud-data-row">
            <span class="text-xs text-cyan-400/60 shrink-0 font-mono" x-text="entry.time"></span>
            <span class="text-sm text-slate-300 ml-3" x-text="entry.msg"></span>
          </div>
        </template>
        <div x-show="activityLog.length === 0" class="text-sm text-slate-500 text-center py-4">No activity yet</div>
      </div>
    </div>
  </div>

  <!-- Quick actions -->
  <div class="mt-6 hud-panel rounded-xl p-5">
    <h2 class="hud-section-title">Quick Actions</h2>
    <div class="flex flex-wrap gap-3">
      <button @click="quickAction('build')" class="hud-btn hud-btn-primary">Build Workspace</button>
      <button @click="quickAction('restart')" class="hud-btn hud-btn-warning">Restart ROS 2</button>
      <button @click="refreshAll()" class="hud-btn hud-btn-secondary">Refresh Status</button>
    </div>
    <div x-show="actionResult" class="mt-3 p-3 rounded-lg bg-slate-900/80 border border-cyan-500/10 text-sm font-mono text-slate-300 whitespace-pre-wrap max-h-40 overflow-y-auto" x-text="actionResult"></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function dashboardApp() {
  return {
    containers: [],
    nodeList: [],
    nodeCount: '-',
    topicCount: '-',
    activityLog: [],
    actionResult: '',

    async init() {
      await this.refreshAll();
      setInterval(() => this.refreshAll(), 10000);
    },

    log(msg) {
      const now = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      this.activityLog.unshift({ time: now, msg });
      if (this.activityLog.length > 50) this.activityLog.pop();
    },

    async refreshAll() {
      this.log('Refreshing system status...');
      await Promise.all([this.fetchContainers(), this.fetchNodes(), this.fetchTopics()]);
    },

    async fetchContainers() {
      try {
        const r = await fetch('/api/docker/containers/');
        const data = await r.json();
        this.containers = data.containers || [];
      } catch(e) { this.containers = []; }
    },

    async fetchNodes() {
      try {
        const r = await fetch('/api/ros2/nodes/');
        const data = await r.json();
        this.nodeList = data.nodes || [];
        this.nodeCount = this.nodeList.length;
      } catch(e) { this.nodeList = []; this.nodeCount = '?'; }
    },

    async fetchTopics() {
      try {
        const r = await fetch('/api/ros2/topics/');
        const data = await r.json();
        this.topicCount = (data.topics || []).length;
      } catch(e) { this.topicCount = '?'; }
    },

    async quickAction(action) {
      this.actionResult = `Running ${action}...`;
      this.log(`Quick action: ${action}`);
      try {
        let r;
        if (action === 'build') {
          r = await fetch('/api/ros2/exec/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ command: 'cd /ros2_ws && colcon build --packages-select by_your_command --symlink-install' })
          });
        } else if (action === 'restart') {
          r = await fetch('/api/docker/restart/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ container: 'billybot-ros2' })
          });
        }
        const data = await r.json();
        this.actionResult = data.output || data.result || JSON.stringify(data);
        this.log(`${action} completed`);
      } catch(e) {
        this.actionResult = `Error: ${e.message}`;
      }
    }
  }
}
</script>
{% endblock %}
