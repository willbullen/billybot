{% extends "core/base.html" %}
{% block title %}Nanobot Chat{% endblock %}
{% block page_title %}Nanobot Chat{% endblock %}

{% block content %}
<div x-data="chatApp()" x-init="init()" class="flex flex-col h-[calc(100vh-8rem)]">

  <!-- Chat messages -->
  <div class="flex-1 hud-panel rounded-xl p-5 mb-4 overflow-y-auto" id="chat-messages">
    <div class="space-y-4">
      <template x-for="(msg, i) in messages" :key="i">
        <div class="flex gap-3" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
          <div class="max-w-[70%] rounded-xl px-4 py-3"
               :class="msg.role === 'user' ? 'bg-cyan-600/20 text-cyan-100 border border-cyan-500/30' : 'bg-slate-800/60 text-slate-200 border border-slate-700/50'">
            <div class="text-sm whitespace-pre-wrap" x-text="msg.content"></div>
            <div class="text-xs mt-1 opacity-50 font-mono" x-text="msg.time"></div>
          </div>
        </div>
      </template>

      <div x-show="thinking" class="flex gap-3 justify-start">
        <div class="bg-slate-800/60 text-slate-400 rounded-xl px-4 py-3 border border-slate-700/50">
          <div class="flex gap-1">
            <span class="w-2 h-2 bg-cyan-500 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
            <span class="w-2 h-2 bg-cyan-500 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
            <span class="w-2 h-2 bg-cyan-500 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
          </div>
        </div>
      </div>

      <div x-show="messages.length === 0 && !thinking" class="text-center text-slate-500 py-12">
        <svg class="w-12 h-12 mx-auto mb-3 text-cyan-500/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        <p class="text-sm">Chat with Nanobot</p>
        <p class="text-xs text-slate-600 mt-1">Ask it to manage the ROS 2 system, run builds, check status...</p>
      </div>
    </div>
  </div>

  <!-- Quick commands -->
  <div class="flex flex-wrap gap-2 mb-3">
    <template x-for="cmd in quickCommands" :key="cmd.label">
      <button @click="sendMessage(cmd.msg)" class="px-3 py-1.5 rounded-lg bg-slate-800/60 border border-cyan-500/10 hover:bg-cyan-600/10 hover:border-cyan-500/30 text-xs text-slate-300 transition-colors" x-text="cmd.label"></button>
    </template>
  </div>

  <!-- Input -->
  <div class="flex gap-3">
    <input x-model="input" @keydown.enter="send()" type="text"
           placeholder="Ask nanobot anything..."
           class="flex-1 px-4 py-3 rounded-xl hud-input">
    <button @click="send()" :disabled="!input.trim() || thinking"
            class="px-6 py-3 rounded-xl bg-cyan-600/20 border border-cyan-500/30 hover:bg-cyan-600/30 disabled:opacity-50 text-cyan-300 text-sm font-medium transition-colors">
      Send
    </button>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function chatApp() {
  return {
    ws: null,
    messages: [],
    input: '',
    thinking: false,

    quickCommands: [
      { label: 'List nodes', msg: 'Use the ros2 tool to list all active nodes' },
      { label: 'List topics', msg: 'Use the ros2 tool to list all topics with verbose mode' },
      { label: 'Build workspace', msg: 'Use the ros2 tool to build the by_your_command package' },
      { label: 'Check health', msg: 'Check the health of all ROS 2 containers and nodes' },
      { label: 'Show logs', msg: 'Use the ros2 tool to show the last 30 log lines' },
    ],

    init() {
      this.connectWs();
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws/chat/`);
      this.ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        this.thinking = false;
        this.messages.push({
          role: 'assistant',
          content: data.content || data.message || JSON.stringify(data),
          time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
        });
        this.$nextTick(() => {
          const el = document.getElementById('chat-messages');
          if (el) el.scrollTop = el.scrollHeight;
        });
      };
      this.ws.onclose = () => setTimeout(() => this.connectWs(), 3000);
    },

    send() {
      const text = this.input.trim();
      if (!text) return;
      this.sendMessage(text);
      this.input = '';
    },

    sendMessage(text) {
      this.messages.push({
        role: 'user',
        content: text,
        time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
      });
      this.thinking = true;
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ message: text }));
      }
      this.$nextTick(() => {
        const el = document.getElementById('chat-messages');
        if (el) el.scrollTop = el.scrollHeight;
      });
    }
  }
}
</script>
{% endblock %}
