{% extends "core/base.html" %}
{% block title %}Logs{% endblock %}
{% block page_title %}Logs{% endblock %}

{% block help_modal %}
<div id="helpModal" class="hidden fixed inset-0 z-50 hud-modal-backdrop flex items-start justify-center pt-20 px-4" onclick="if(event.target===this)this.classList.add('hidden')">
  <div class="hud-modal rounded-2xl max-w-2xl w-full max-h-[75vh] overflow-y-auto p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-white tracking-tight">Logs Viewer Documentation</h2>
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-slate-500 hover:text-white transition-colors text-xl leading-none">&times;</button>
    </div>

    <div class="doc-section">
      <h3>Overview</h3>
      <p>The Logs Viewer provides real-time access to Docker container stdout/stderr streams. Logs are fetched via <code>/api/docker/logs/</code> which runs <code>docker logs --tail &lt;N&gt;</code> on the selected container.</p>
      <p>When auto-scroll is enabled, logs refresh every <code>5 seconds</code> automatically.</p>
    </div>

    <div class="doc-section">
      <h3>Container Selection</h3>
      <p>Select which container&rsquo;s logs to view. Each container generates different log output:</p>
      <dl class="doc-grid">
        <dt>billybot-ros2</dt>
        <dd>ROS 2 container logs. Includes all node output: motor driver, audio pipeline, command processor, SLAM, Nav2, behavior manager. Most verbose &mdash; look here for hardware errors and node lifecycle events.</dd>
        <dt>billybot-nanobot</dt>
        <dd>Nanobot AI gateway logs. Shows agent requests, tool invocations, model API calls, cron job execution, and memory operations.</dd>
        <dt>billybot-dashboard</dt>
        <dd>Django dashboard logs. Shows HTTP requests, WebSocket connections, API calls, and any server-side errors.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Controls</h3>
      <dl class="doc-grid">
        <dt>Line Count</dt>
        <dd>Number of trailing log lines to fetch: 50, 100, 200, or 500. Higher counts take longer but show more history. Maps to <code>docker logs --tail N</code>.</dd>
        <dt>Filter</dt>
        <dd>Case-insensitive substring filter applied client-side. Use to isolate specific nodes, error levels, or keywords. Examples: <code>ERROR</code>, <code>ddsm</code>, <code>nav2</code>.</dd>
        <dt>Auto-scroll</dt>
        <dd>When enabled, logs auto-refresh every 5 seconds and the view scrolls to the bottom. Disable to freeze the view while investigating an issue.</dd>
        <dt>Refresh</dt>
        <dd>Manual refresh button. Fetches the latest N lines from the selected container.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Log Level Coloring</h3>
      <p>Log lines are automatically color-coded by severity level for quick scanning:</p>
      <dl class="doc-grid">
        <dt class="text-red-400">ERROR / error</dt>
        <dd>Red text. Critical failures &mdash; node crashes, hardware communication failures, missing dependencies.</dd>
        <dt class="text-amber-400">WARN / warn</dt>
        <dd>Amber text. Non-fatal issues &mdash; timeouts, degraded performance, missing optional components.</dd>
        <dt class="text-cyan-300/70">INFO / info</dt>
        <dd>Cyan text. Normal operational messages &mdash; node startup, topic subscriptions, configuration loaded.</dd>
        <dt class="text-slate-400">Other</dt>
        <dd>Default grey. Debug output, raw data, timestamps without level prefix.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Common Log Patterns</h3>
      <dl class="doc-grid">
        <dt>Node startup</dt>
        <dd><code>[INFO] [ddsm_driver_node]: Node initialized</code> &mdash; Confirms a node has started and is ready.</dd>
        <dt>Motor timeout</dt>
        <dd><code>[WARN] [ddsm_driver_node]: Motor 1 response timeout</code> &mdash; DDSM210 didn&rsquo;t respond within expected window. Check USB connection.</dd>
        <dt>Nav2 goal</dt>
        <dd><code>[INFO] [bt_navigator]: Navigating to goal...</code> &mdash; Nav2 accepted a navigation goal.</dd>
        <dt>SLAM update</dt>
        <dd><code>[INFO] [slam_toolbox]: Updated map</code> &mdash; SLAM toolbox updated the occupancy grid.</dd>
        <dt>Audio VAD</dt>
        <dd><code>[INFO] [audio_pipeline_node]: VAD: speech_start</code> &mdash; Voice activity detection triggered.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Troubleshooting Tips</h3>
      <div class="info-box">
        <p><strong>No logs appearing?</strong> Ensure the container is running. Check the Settings page for container status.</p>
        <p class="mt-2"><strong>Missing recent output?</strong> Docker log rotation may have cleared old entries. Increase line count to 500.</p>
        <p class="mt-2"><strong>Too much noise?</strong> Use the filter to isolate relevant output. Try filtering by node name or <code>ERROR</code>.</p>
      </div>
    </div>

    <div class="doc-section">
      <h3>API Endpoint</h3>
      <dl class="doc-grid">
        <dt>GET /api/docker/logs/</dt>
        <dd>Fetch container logs. Params: <code>container</code> (container name), <code>lines</code> (number of trailing lines).</dd>
      </dl>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div x-data="logsApp()" x-init="init()">

  <!-- Toolbar -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div class="flex items-center gap-3">
      <select x-model="selectedContainer" @change="fetchLogs()" class="hud-input">
        <option value="billybot-ros2">ROS 2</option>
        <option value="billybot-nanobot">Nanobot</option>
        <option value="billybot-dashboard">Dashboard</option>
      </select>
      <select x-model="lineCount" @change="fetchLogs()" class="hud-input">
        <option value="50">50 lines</option>
        <option value="100">100 lines</option>
        <option value="200">200 lines</option>
        <option value="500">500 lines</option>
      </select>
      <input x-model="logFilter" type="text" placeholder="Filter..."
             class="hud-input w-48">
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
        <input type="checkbox" x-model="autoScroll" class="rounded bg-slate-700 border-cyan-500/30 text-cyan-500 focus:ring-cyan-500/50">
        Auto-scroll
      </label>
      <button @click="fetchLogs()" class="hud-btn hud-btn-secondary">Refresh</button>
    </div>
  </div>

  <!-- Log output -->
  <div class="hud-panel rounded-xl p-4">
    <div id="log-output" class="font-mono text-xs leading-relaxed max-h-[calc(100vh-16rem)] overflow-y-auto space-y-0">
      <template x-for="(line, i) in filteredLines" :key="i">
        <div class="px-2 py-0.5 hover:bg-slate-800/50 rounded"
             :class="{
               'text-red-400': line.includes('ERROR') || line.includes('error'),
               'text-amber-400': line.includes('WARN') || line.includes('warn'),
               'text-cyan-300/70': line.includes('INFO') || line.includes('info'),
               'text-slate-400': !(line.includes('ERROR') || line.includes('error') || line.includes('WARN') || line.includes('warn') || line.includes('INFO') || line.includes('info'))
             }" x-text="line"></div>
      </template>
      <div x-show="filteredLines.length === 0" class="text-slate-500 text-center py-8">
        <span x-show="loading">Loading logs...</span>
        <span x-show="!loading">No log lines</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function logsApp() {
  return {
    selectedContainer: 'billybot-ros2',
    lineCount: '100',
    logFilter: '',
    logLines: [],
    autoScroll: true,
    loading: true,

    get filteredLines() {
      if (!this.logFilter) return this.logLines;
      const f = this.logFilter.toLowerCase();
      return this.logLines.filter(l => l.toLowerCase().includes(f));
    },

    async init() {
      await this.fetchLogs();
      setInterval(() => { if (this.autoScroll) this.fetchLogs(); }, 5000);
    },

    async fetchLogs() {
      this.loading = true;
      try {
        const r = await fetch(`/api/docker/logs/?container=${this.selectedContainer}&lines=${this.lineCount}`);
        const data = await r.json();
        this.logLines = (data.logs || '').split('\n').filter(l => l.trim());
      } catch(e) { this.logLines = [`Error fetching logs: ${e.message}`]; }
      this.loading = false;
      if (this.autoScroll) {
        this.$nextTick(() => {
          const el = document.getElementById('log-output');
          if (el) el.scrollTop = el.scrollHeight;
        });
      }
    }
  }
}
</script>
{% endblock %}
