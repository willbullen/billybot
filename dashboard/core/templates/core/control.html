{% extends "core/base.html" %}
{% block title %}ROBOT CONTROL{% endblock %}
{% block page_title %}ROBOT CONTROL{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.2/nipplejs.min.js"></script>
<style>
  .joystick-zone { touch-action: none; }
  .estop-btn {
    box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
    transition: all 0.3s ease;
  }
  .estop-btn:hover { box-shadow: 0 0 50px rgba(239, 68, 68, 0.5); }
  .preset-btn { min-width: 88px; min-height: 44px; }
  .hud-panel {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(6, 182, 212, 0.2);
  }
  .hud-panel:hover {
    border-color: rgba(6, 182, 212, 0.35);
  }
</style>
{% endblock %}

{% block content %}
<div x-data="controlApp()" x-init="init()">

  <!-- Connection + E-Stop HUD bar -->
  <div class="flex items-center justify-between mb-6 hud-panel rounded-lg p-4">
    <div class="flex items-center gap-6">
      <div class="flex items-center gap-2 text-sm font-mono">
        <span class="w-3 h-3 rounded-full" :class="wsConnected ? 'bg-cyan-400 animate-pulse' : 'bg-red-500'"></span>
        <span class="uppercase tracking-wider" :class="wsConnected ? 'text-cyan-200' : 'text-red-300'" x-text="wsConnected ? 'BRIDGE ONLINE' : 'BRIDGE OFFLINE'"></span>
      </div>
      <div class="border-l border-cyan-500/20 pl-6 flex items-center gap-4 text-xs font-mono text-slate-400">
        <span class="text-cyan-300/60 uppercase">LIN: <span class="text-cyan-100" x-text="currentLinear.toFixed(2)"></span></span>
        <span class="text-cyan-300/60 uppercase">ANG: <span class="text-cyan-100" x-text="currentAngular.toFixed(2)"></span></span>
      </div>
    </div>
    <button @click="emergencyStop()" class="estop-btn px-8 py-3 rounded-lg bg-red-600 hover:bg-red-700 border border-red-500/30 text-white font-mono font-bold text-lg uppercase tracking-widest">
      E-STOP
    </button>
  </div>

  <!-- Main control area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

    <!-- Drive joystick -->
    <div class="hud-panel rounded-lg p-6 flex flex-col items-center">
      <div class="flex items-center gap-2 mb-1">
        <div class="w-2 h-2 bg-cyan-400 rounded-full"></div>
        <h2 class="text-sm font-mono font-semibold text-cyan-200 uppercase tracking-widest">DRIVE</h2>
      </div>
      <p class="text-xs font-mono text-slate-500 uppercase mb-4">FORWARD / BACKWARD / TURN</p>
      <div id="drive-zone" class="joystick-zone w-52 h-52 rounded-full bg-slate-800/60 border border-cyan-500/20 relative"></div>
      <div class="mt-4 w-full">
        <label class="text-xs font-mono text-cyan-300/60 uppercase tracking-wider">MAX SPEED</label>
        <input type="range" x-model="maxSpeed" min="0.1" max="1.0" step="0.05" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500 mt-1">
        <div class="text-xs font-mono text-cyan-100 text-center mt-1" x-text="(maxSpeed * 100).toFixed(0) + '%'"></div>
      </div>
    </div>

    <!-- Camera feed + status -->
    <div class="hud-panel rounded-lg p-6 flex flex-col">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-2 h-2 bg-cyan-400 rounded-full"></div>
        <h2 class="text-sm font-mono font-semibold text-cyan-200 uppercase tracking-widest">CAMERA FEED</h2>
      </div>
      <div class="flex-1 bg-slate-800/60 rounded-lg border border-cyan-500/20 flex items-center justify-center min-h-[220px]">
        <div class="text-center">
          <svg class="w-12 h-12 mx-auto mb-2 text-cyan-500/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <p class="text-sm font-mono text-cyan-200/60 uppercase">NO SIGNAL</p>
          <p class="text-xs font-mono text-slate-600 mt-1 uppercase">REQUIRES CAMERA DRIVER (STAGE 4)</p>
        </div>
      </div>
      <!-- Voice control -->
      <div class="flex items-center justify-between mt-4 pt-4 border-t border-cyan-500/20">
        <span class="text-sm font-mono text-cyan-200 uppercase tracking-wider">VOICE ACTIVE</span>
        <button @click="toggleVoice()" class="relative w-11 h-6 rounded-full transition-colors border" :class="voiceActive ? 'bg-cyan-500/20 border-cyan-500/50' : 'bg-slate-700 border-slate-600'">
          <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full shadow transition-transform" :class="voiceActive ? 'translate-x-5 bg-cyan-400' : 'bg-slate-400'"></span>
        </button>
      </div>
    </div>

    <!-- Pan/Tilt joystick -->
    <div class="hud-panel rounded-lg p-6 flex flex-col items-center">
      <div class="flex items-center gap-2 mb-1">
        <div class="w-2 h-2 bg-cyan-400 rounded-full"></div>
        <h2 class="text-sm font-mono font-semibold text-cyan-200 uppercase tracking-widest">CAMERA PAN/TILT</h2>
      </div>
      <p class="text-xs font-mono text-slate-500 uppercase mb-4">PAN LEFT/RIGHT / TILT UP/DOWN</p>
      <div id="pantilt-zone" class="joystick-zone w-52 h-52 rounded-full bg-slate-800/60 border border-cyan-500/20 relative"></div>
      <button @click="sendPreset('forward')" class="mt-4 px-4 py-2 rounded-lg border border-cyan-500/30 text-cyan-300 hover:bg-cyan-500/20 text-sm font-mono uppercase tracking-wider transition-colors">HOME POSITION</button>
    </div>
  </div>

  <!-- Arm presets -->
  <div class="mt-4 hud-panel rounded-lg p-5">
    <div class="flex items-center gap-2 mb-4">
      <div class="w-2 h-2 bg-cyan-400 rounded-full"></div>
      <h2 class="text-sm font-mono font-semibold text-cyan-200 uppercase tracking-widest">ARM PRESETS</h2>
    </div>
    <div class="flex flex-wrap gap-3">
      <template x-for="preset in armPresets" :key="preset.id">
        <button @click="sendPreset(preset.id)" class="preset-btn px-5 py-2.5 rounded-lg text-sm font-mono font-medium uppercase tracking-wider transition-all border"
                :class="activePreset === preset.id ? 'bg-cyan-500/20 text-cyan-100 border-cyan-500 ring-1 ring-cyan-500/50' : 'bg-slate-700/50 text-cyan-300 border-cyan-500/30 hover:bg-cyan-500/10'">
          <span x-text="preset.label.toUpperCase()"></span>
        </button>
      </template>
    </div>
  </div>

  <!-- Bearing presets -->
  <div class="mt-4 hud-panel rounded-lg p-5">
    <div class="flex items-center gap-2 mb-4">
      <div class="w-2 h-2 bg-cyan-400 rounded-full"></div>
      <h2 class="text-sm font-mono font-semibold text-cyan-200 uppercase tracking-widest">BEARING</h2>
    </div>
    <div class="flex flex-wrap gap-3">
      <template x-for="bearing in bearingPresets" :key="bearing.id">
        <button @click="sendBearing(bearing.id)" class="preset-btn px-5 py-2.5 rounded-lg text-sm font-mono font-medium uppercase tracking-wider transition-all border"
                :class="activeBearing === bearing.id ? 'bg-cyan-500/20 text-cyan-100 border-cyan-500 ring-1 ring-cyan-500/50' : 'bg-slate-700/50 text-cyan-300 border-cyan-500/30 hover:bg-cyan-500/10'">
          <span x-text="bearing.label.toUpperCase()"></span>
        </button>
      </template>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function controlApp() {
  return {
    ws: null,
    wsConnected: false,
    maxSpeed: 0.5,
    maxTurn: 1.0,
    currentLinear: 0,
    currentAngular: 0,
    voiceActive: true,
    activePreset: null,
    activeBearing: null,
    driveJoystick: null,
    pantiltJoystick: null,
    cmdInterval: null,

    armPresets: [
      { id: 'bumper', label: 'Bumper' },
      { id: 'tenhut', label: 'Ten-Hut' },
      { id: 'lookup', label: 'Look Up' },
      { id: 'lookout', label: 'Look Out' },
      { id: 'reach', label: 'Reach' },
    ],

    bearingPresets: [
      { id: 'back-left', label: 'Back Left' },
      { id: 'full-left', label: 'Full Left' },
      { id: 'left', label: 'Left' },
      { id: 'leftish', label: 'Leftish' },
      { id: 'forward', label: 'Forward' },
      { id: 'rightish', label: 'Rightish' },
      { id: 'right', label: 'Right' },
      { id: 'full-right', label: 'Full Right' },
      { id: 'back-right', label: 'Back Right' },
      { id: 'back', label: 'Back' },
    ],

    init() {
      this.connectWs();
      this.$nextTick(() => {
        this.setupDriveJoystick();
        this.setupPantiltJoystick();
      });
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws/ros2/`);
      this.ws.onopen = () => { this.wsConnected = true; };
      this.ws.onclose = () => {
        this.wsConnected = false;
        setTimeout(() => this.connectWs(), 3000);
      };
      this.ws.onerror = () => { this.wsConnected = false; };
    },

    sendCmd(type, data) {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type, ...data }));
      }
    },

    setupDriveJoystick() {
      const zone = document.getElementById('drive-zone');
      if (!zone) return;
      this.driveJoystick = nipplejs.create({
        zone, mode: 'static', position: { left: '50%', top: '50%' },
        color: '#06b6d4', size: 140, threshold: 0.05, fadeTime: 100, multitouch: false,
      });
      this.driveJoystick.on('move', (evt, data) => {
        const force = Math.min(data.force, 1.0);
        const rad = data.angle.radian;
        this.currentLinear = Math.sin(rad) * force * this.maxSpeed;
        this.currentAngular = -Math.cos(rad) * force * this.maxTurn;
        // Dead zone
        if (Math.abs(this.currentLinear) < 0.03) this.currentLinear = 0;
        if (Math.abs(this.currentAngular) < 0.03) this.currentAngular = 0;
      });
      this.driveJoystick.on('end', () => {
        this.currentLinear = 0;
        this.currentAngular = 0;
        this.sendCmd('cmd_vel', { linear: {x:0,y:0,z:0}, angular: {x:0,y:0,z:0} });
      });
      // Send cmd_vel at 10Hz while joystick active
      this.cmdInterval = setInterval(() => {
        if (this.currentLinear !== 0 || this.currentAngular !== 0) {
          this.sendCmd('cmd_vel', {
            linear: { x: this.currentLinear, y: 0, z: 0 },
            angular: { x: 0, y: 0, z: this.currentAngular }
          });
        }
      }, 100);
    },

    setupPantiltJoystick() {
      const zone = document.getElementById('pantilt-zone');
      if (!zone) return;
      this.pantiltJoystick = nipplejs.create({
        zone, mode: 'static', position: { left: '50%', top: '50%' },
        color: '#06b6d4', size: 140, threshold: 0.05, fadeTime: 100, multitouch: false,
      });
      this.pantiltJoystick.on('move', (evt, data) => {
        const force = Math.min(data.force, 1.0);
        const rad = data.angle.radian;
        const pan = -Math.cos(rad) * force;
        const tilt = Math.sin(rad) * force;
        this.sendCmd('pantilt', { pan, tilt });
      });
      this.pantiltJoystick.on('end', () => {
        this.sendCmd('pantilt', { pan: 0, tilt: 0 });
      });
    },

    emergencyStop() {
      this.currentLinear = 0;
      this.currentAngular = 0;
      this.sendCmd('cmd_vel', { linear: {x:0,y:0,z:0}, angular: {x:0,y:0,z:0} });
      this.sendCmd('estop', {});
      // Flash the page red briefly
      document.body.style.boxShadow = 'inset 0 0 100px rgba(239,68,68,0.3)';
      setTimeout(() => { document.body.style.boxShadow = ''; }, 500);
    },

    sendPreset(preset) {
      this.activePreset = preset;
      this.sendCmd('arm_preset', { preset });
    },

    sendBearing(bearing) {
      this.activeBearing = bearing;
      this.sendCmd('bearing', { bearing });
    },

    toggleVoice() {
      this.voiceActive = !this.voiceActive;
      this.sendCmd('voice_active', { active: this.voiceActive });
    },
  }
}
</script>
{% endblock %}
