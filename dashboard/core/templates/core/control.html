{% extends "core/base.html" %}
{% block title %}Robot Control{% endblock %}
{% block page_title %}Robot Control{% endblock %}

{% block help_modal %}
<div id="helpModal" class="hidden fixed inset-0 z-50 hud-modal-backdrop flex items-start justify-center pt-20 px-4" onclick="if(event.target===this)this.classList.add('hidden')">
  <div class="hud-modal rounded-2xl max-w-2xl w-full max-h-[75vh] overflow-y-auto p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-white tracking-tight">Robot Control Documentation</h2>
      <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-slate-500 hover:text-white transition-colors text-xl leading-none">&times;</button>
    </div>

    <div class="doc-section">
      <h3>Overview</h3>
      <p>The Control page provides real-time manual control of the robot via touch-friendly joysticks, arm presets, and bearing commands. All commands are sent over WebSocket to the ROS 2 container via <code>ws/ros2/</code>.</p>
      <p>The control interface is designed for both desktop (mouse) and mobile/tablet (touch) operation.</p>
    </div>

    <div class="doc-section">
      <h3>Drive Joystick (Left)</h3>
      <p>The left joystick controls robot movement by publishing <code>geometry_msgs/Twist</code> to <code>/cmd_vel</code> at 10 Hz while active.</p>
      <dl class="doc-grid">
        <dt>Forward/Back</dt>
        <dd>Controls linear.x velocity (range: -1.0 to 1.0 m/s). Push up to move forward.</dd>
        <dt>Left/Right</dt>
        <dd>Controls angular.z velocity (range: -3.0 to 3.0 rad/s). Push right to turn right.</dd>
        <dt>Release</dt>
        <dd>Automatically sends zero velocity (stop command) when joystick is released.</dd>
        <dt>Library</dt>
        <dd>Built with <code>nipple.js</code> - a virtual joystick library for touch interfaces.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Pan/Tilt Joystick (Right)</h3>
      <p>Controls the camera pan/tilt head via <code>/pantilt_cmd</code> (geometry_msgs/Vector3).</p>
      <dl class="doc-grid">
        <dt>Pan (x-axis)</dt>
        <dd>Horizontal camera rotation. Range maps to servo position.</dd>
        <dt>Tilt (y-axis)</dt>
        <dd>Vertical camera angle. Range maps to servo position.</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>E-STOP</h3>
      <div class="warn-box">
        <p><strong>Emergency Stop</strong> immediately publishes a zero-velocity Twist message to <code>/cmd_vel</code>, halting all motor movement. The button pulses red to indicate it&rsquo;s always ready. Use this any time the robot behaves unexpectedly.</p>
      </div>
    </div>

    <div class="doc-section">
      <h3>Arm Presets</h3>
      <p>Predefined arm positions published to <code>/grunt1/arm_preset</code>:</p>
      <dl class="doc-grid">
        <dt>Bumper</dt>
        <dd>Arm retracted in front, low position. Protective stance. Servo values: [2048, 3072].</dd>
        <dt>Ten-Hut</dt>
        <dd>Home/center position. Both servos at midpoint [2048, 2048].</dd>
        <dt>Look Up</dt>
        <dd>Camera aimed upward. Pan center, tilt up [2048, 1024].</dd>
        <dt>Look Out</dt>
        <dd>Camera aimed forward at mid-height. Scanning position [2048, 1536].</dd>
        <dt>Reach</dt>
        <dd>Arm extended forward. Maximum reach position [2048, 512].</dd>
      </dl>
    </div>

    <div class="doc-section">
      <h3>Bearing Presets</h3>
      <p>Directional bearings that modify arm pan angle. Sent as compound commands (e.g., <code>lookout@leftish</code>):</p>
      <div class="flex flex-wrap gap-1 mt-2">
        <span class="topic-tag">back-left</span><span class="topic-tag">full-left</span><span class="topic-tag">left</span><span class="topic-tag">leftish</span><span class="topic-tag">forward</span><span class="topic-tag">rightish</span><span class="topic-tag">right</span><span class="topic-tag">full-right</span><span class="topic-tag">back-right</span><span class="topic-tag">back</span>
      </div>
    </div>

    <div class="doc-section">
      <h3>Camera Feed</h3>
      <p>Live camera stream from <code>/camera/color/compressed</code> via the CameraConsumer WebSocket (<code>ws/camera/</code>). The feed shows frames as base64-encoded JPEG images at the configured FPS.</p>
      <p>If the camera is offline, a placeholder is shown. Launch the camera with:</p>
      <div class="info-box mt-2">
        <code>ros2 launch by_your_command camera.launch.py simulate:=true</code>
      </div>
    </div>

    <div class="doc-section">
      <h3>Topics Used</h3>
      <div class="flex flex-wrap gap-1">
        <span class="topic-tag">/cmd_vel</span><span class="topic-tag">/pantilt_cmd</span><span class="topic-tag">/grunt1/arm_preset</span><span class="topic-tag">/behavior_command</span><span class="topic-tag">/voice_active</span><span class="topic-tag">/camera/color/compressed</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.2/nipplejs.min.js"></script>
<style>
  .joystick-zone { touch-action: none; }
  .estop-btn {
    box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
    transition: all 0.3s ease;
  }
  .estop-btn:hover { box-shadow: 0 0 50px rgba(239, 68, 68, 0.5); }
  .preset-btn { min-width: 88px; min-height: 44px; }
  .hud-panel {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(6, 182, 212, 0.2);
  }
  .hud-panel:hover {
    border-color: rgba(6, 182, 212, 0.35);
  }
</style>
{% endblock %}

{% block content %}
<div x-data="controlApp()" x-init="init()">

  <!-- Connection + E-Stop bar -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2 text-sm">
        <span class="w-2.5 h-2.5 rounded-full" :class="wsConnected ? 'bg-emerald-500 pulse-dot' : 'bg-red-500'"></span>
        <span class="text-slate-400" x-text="wsConnected ? 'Bridge connected' : 'Bridge disconnected'"></span>
      </div>
      <div class="text-xs text-slate-500 font-mono">
        Lin: <span x-text="currentLinear.toFixed(2)" class="text-cyan-300"></span> |
        Ang: <span x-text="currentAngular.toFixed(2)" class="text-cyan-300"></span>
      </div>
    </div>
    <button @click="emergencyStop()" class="estop-btn px-6 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-lg uppercase tracking-wider transition-all">
      E-STOP
    </button>
  </div>

  <!-- Main control area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Drive joystick -->
    <div class="hud-panel rounded-xl p-6 flex flex-col items-center">
      <h2 class="text-sm font-semibold text-cyan-200 uppercase tracking-wider mb-2">Drive</h2>
      <p class="text-xs text-slate-500 mb-4">Forward / Backward / Turn</p>
      <div id="drive-zone" class="joystick-zone w-52 h-52 rounded-full bg-slate-800/60 border border-cyan-500/20 relative"></div>
      <div class="mt-4 w-full">
        <label class="text-xs text-slate-500">Max Speed</label>
        <input type="range" x-model="maxSpeed" min="0.1" max="1.0" step="0.05" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
        <div class="text-xs text-slate-400 text-center" x-text="(maxSpeed * 100).toFixed(0) + '%'"></div>
      </div>
    </div>

    <!-- Camera feed + status -->
    <div class="hud-panel rounded-xl p-6 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-cyan-200 uppercase tracking-wider">Camera Feed</h2>
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full" :class="cameraConnected ? 'bg-emerald-500 pulse-dot' : 'bg-slate-600'"></span>
          <span class="text-xs text-slate-500" x-text="cameraConnected ? 'Live' : 'Offline'"></span>
        </div>
      </div>
      <div class="flex-1 bg-slate-800/60 rounded-lg border border-cyan-500/20 flex items-center justify-center min-h-[220px] overflow-hidden relative">
        <!-- Live camera frame -->
        <img x-show="cameraFrame" :src="'data:image/jpeg;base64,' + cameraFrame" class="w-full h-full object-contain" alt="Camera feed">
        <!-- Offline placeholder -->
        <div x-show="!cameraFrame" class="text-center text-slate-500">
          <svg class="w-12 h-12 mx-auto mb-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <p class="text-sm">Waiting for camera...</p>
          <p class="text-xs text-slate-600 mt-1">Launch camera driver to stream</p>
        </div>
      </div>
      <!-- Voice control -->
      <div class="flex items-center justify-between mt-4 pt-4 border-t border-cyan-500/20">
        <span class="text-sm text-slate-400">Voice Active</span>
        <button @click="toggleVoice()" class="relative w-11 h-6 rounded-full transition-colors border" :class="voiceActive ? 'bg-cyan-500/20 border-cyan-500/50' : 'bg-slate-600 border-slate-500'">
          <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full shadow transition-transform" :class="voiceActive ? 'translate-x-5 bg-cyan-400' : 'bg-slate-400'"></span>
        </button>
      </div>
    </div>

    <!-- Pan/Tilt joystick -->
    <div class="hud-panel rounded-xl p-6 flex flex-col items-center">
      <h2 class="text-sm font-semibold text-cyan-200 uppercase tracking-wider mb-2">Camera Pan/Tilt</h2>
      <p class="text-xs text-slate-500 mb-4">Pan Left/Right / Tilt Up/Down</p>
      <div id="pantilt-zone" class="joystick-zone w-52 h-52 rounded-full bg-slate-800/60 border border-cyan-500/20 relative"></div>
      <button @click="sendPreset('forward')" class="mt-4 px-4 py-2 rounded-lg border border-cyan-500/30 text-cyan-300 hover:bg-cyan-500/20 text-sm transition-colors">Home Position</button>
    </div>
  </div>

  <!-- Arm presets -->
  <div class="mt-6 hud-panel rounded-xl p-5">
    <h2 class="text-sm font-semibold text-cyan-200 uppercase tracking-wider mb-4">Arm Presets</h2>
    <div class="flex flex-wrap gap-3">
      <template x-for="preset in armPresets" :key="preset.id">
        <button @click="sendPreset(preset.id)" class="preset-btn px-5 py-2.5 rounded-lg text-sm font-medium transition-all border"
                :class="activePreset === preset.id ? 'bg-cyan-500/20 text-cyan-100 border-cyan-500 ring-2 ring-cyan-400/30' : 'bg-slate-700/50 text-slate-300 border-cyan-500/20 hover:bg-slate-600/50 hover:border-cyan-500/30'">
          <span x-text="preset.label"></span>
        </button>
      </template>
    </div>
  </div>

  <!-- Bearing presets -->
  <div class="mt-4 hud-panel rounded-xl p-5">
    <h2 class="text-sm font-semibold text-cyan-200 uppercase tracking-wider mb-4">Bearing</h2>
    <div class="flex flex-wrap gap-3">
      <template x-for="bearing in bearingPresets" :key="bearing.id">
        <button @click="sendBearing(bearing.id)" class="preset-btn px-5 py-2.5 rounded-lg text-sm font-medium transition-all border"
                :class="activeBearing === bearing.id ? 'bg-cyan-500/20 text-cyan-100 border-cyan-500 ring-2 ring-cyan-400/30' : 'bg-slate-700/50 text-slate-300 border-cyan-500/20 hover:bg-slate-600/50 hover:border-cyan-500/30'">
          <span x-text="bearing.label"></span>
        </button>
      </template>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function controlApp() {
  return {
    ws: null,
    wsConnected: false,
    camWs: null,
    cameraConnected: false,
    cameraFrame: null,
    maxSpeed: 0.5,
    maxTurn: 1.0,
    currentLinear: 0,
    currentAngular: 0,
    voiceActive: true,
    activePreset: null,
    activeBearing: null,
    driveJoystick: null,
    pantiltJoystick: null,
    cmdInterval: null,

    armPresets: [
      { id: 'bumper', label: 'Bumper' },
      { id: 'tenhut', label: 'Ten-Hut' },
      { id: 'lookup', label: 'Look Up' },
      { id: 'lookout', label: 'Look Out' },
      { id: 'reach', label: 'Reach' },
    ],

    bearingPresets: [
      { id: 'back-left', label: 'Back Left' },
      { id: 'full-left', label: 'Full Left' },
      { id: 'left', label: 'Left' },
      { id: 'leftish', label: 'Leftish' },
      { id: 'forward', label: 'Forward' },
      { id: 'rightish', label: 'Rightish' },
      { id: 'right', label: 'Right' },
      { id: 'full-right', label: 'Full Right' },
      { id: 'back-right', label: 'Back Right' },
      { id: 'back', label: 'Back' },
    ],

    init() {
      this.connectWs();
      this.connectCameraWs();
      this.$nextTick(() => {
        this.setupDriveJoystick();
        this.setupPantiltJoystick();
      });
    },

    connectCameraWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.camWs = new WebSocket(`${proto}//${location.host}/ws/camera/`);
      this.camWs.onopen = () => { this.cameraConnected = true; };
      this.camWs.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === 'frame' && data.data) {
            this.cameraFrame = data.data;
          }
        } catch(err) {}
      };
      this.camWs.onclose = () => {
        this.cameraConnected = false;
        this.cameraFrame = null;
        setTimeout(() => this.connectCameraWs(), 5000);
      };
      this.camWs.onerror = () => { this.cameraConnected = false; };
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws/ros2/`);
      this.ws.onopen = () => { this.wsConnected = true; };
      this.ws.onclose = () => {
        this.wsConnected = false;
        setTimeout(() => this.connectWs(), 3000);
      };
      this.ws.onerror = () => { this.wsConnected = false; };
    },

    sendCmd(type, data) {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type, ...data }));
      }
    },

    setupDriveJoystick() {
      const zone = document.getElementById('drive-zone');
      if (!zone) return;
      this.driveJoystick = nipplejs.create({
        zone, mode: 'static', position: { left: '50%', top: '50%' },
        color: '#06b6d4', size: 140, threshold: 0.05, fadeTime: 100, multitouch: false,
      });
      this.driveJoystick.on('move', (evt, data) => {
        const force = Math.min(data.force, 1.0);
        const rad = data.angle.radian;
        this.currentLinear = Math.sin(rad) * force * this.maxSpeed;
        this.currentAngular = -Math.cos(rad) * force * this.maxTurn;
        // Dead zone
        if (Math.abs(this.currentLinear) < 0.03) this.currentLinear = 0;
        if (Math.abs(this.currentAngular) < 0.03) this.currentAngular = 0;
      });
      this.driveJoystick.on('end', () => {
        this.currentLinear = 0;
        this.currentAngular = 0;
        this.sendCmd('cmd_vel', { linear: {x:0,y:0,z:0}, angular: {x:0,y:0,z:0} });
      });
      // Send cmd_vel at 10Hz while joystick active
      this.cmdInterval = setInterval(() => {
        if (this.currentLinear !== 0 || this.currentAngular !== 0) {
          this.sendCmd('cmd_vel', {
            linear: { x: this.currentLinear, y: 0, z: 0 },
            angular: { x: 0, y: 0, z: this.currentAngular }
          });
        }
      }, 100);
    },

    setupPantiltJoystick() {
      const zone = document.getElementById('pantilt-zone');
      if (!zone) return;
      this.pantiltJoystick = nipplejs.create({
        zone, mode: 'static', position: { left: '50%', top: '50%' },
        color: '#06b6d4', size: 140, threshold: 0.05, fadeTime: 100, multitouch: false,
      });
      this.pantiltJoystick.on('move', (evt, data) => {
        const force = Math.min(data.force, 1.0);
        const rad = data.angle.radian;
        const pan = -Math.cos(rad) * force;
        const tilt = Math.sin(rad) * force;
        this.sendCmd('pantilt', { pan, tilt });
      });
      this.pantiltJoystick.on('end', () => {
        this.sendCmd('pantilt', { pan: 0, tilt: 0 });
      });
    },

    emergencyStop() {
      this.currentLinear = 0;
      this.currentAngular = 0;
      this.sendCmd('cmd_vel', { linear: {x:0,y:0,z:0}, angular: {x:0,y:0,z:0} });
      this.sendCmd('estop', {});
      // Flash the page red briefly
      document.body.style.boxShadow = 'inset 0 0 100px rgba(239,68,68,0.3)';
      setTimeout(() => { document.body.style.boxShadow = ''; }, 500);
    },

    sendPreset(preset) {
      this.activePreset = preset;
      this.sendCmd('arm_preset', { preset });
    },

    sendBearing(bearing) {
      this.activeBearing = bearing;
      this.sendCmd('bearing', { bearing });
    },

    toggleVoice() {
      this.voiceActive = !this.voiceActive;
      this.sendCmd('voice_active', { active: this.voiceActive });
    },
  }
}
</script>
{% endblock %}
